import{a as _}from"./chunk-DI4EKB66.js";import{a as Q}from"./chunk-NCWQX36D.js";import{J as W,K as Ce,L as I,M as N,N as Se,O as Fe,P as xe,d as ye,e as y,f as S,g as F,k as be,m as x,n as E,o as w,r as ge,t as k,u as ke}from"./chunk-6JUBYSQI.js";import{$a as pe,Ba as V,Ea as b,Fa as h,G as ne,H as P,Ia as L,J as ae,Ja as ce,Jb as q,Kb as U,La as O,Ma as A,Mb as $,N as f,Na as B,Nb as he,O as T,Oa as se,Pa as p,Qa as R,Sa as me,T as D,U as G,_a as le,da as m,ea as u,f as Z,lb as de,mb as g,p as ie,pa as v,q as oe,ra as s,sb as ue,tb as fe,va as n,wa as c,xa as l,xb as ve}from"./chunk-V45PRMTZ.js";function Qe(i,e){if(i&1){let a=V();n(0,"div",6)(1,"div",7)(2,"h4"),p(3,"Shipping address"),c(),n(4,"button",8),b("click",function(){D(a);let t=h();return G(t.saveUserAddress())}),p(5," Save as default address "),c()(),n(6,"div",9)(7,"div",10),l(8,"app-text-input",11),c(),n(9,"div",10),l(10,"app-text-input",12),c(),n(11,"div",10),l(12,"app-text-input",13),c(),n(13,"div",10),l(14,"app-text-input",14),c(),n(15,"div",10),l(16,"app-text-input",15),c(),n(17,"div",10),l(18,"app-text-input",16),c()()()}if(i&2){let a,r=h();s("formGroup",r.checkoutForm),m(4),s("disabled",!((a=r.checkoutForm.get("addressForm"))!=null&&a.valid)||!((a=r.checkoutForm.get("addressForm"))!=null&&a.dirty)),m(4),s("label","First name"),m(2),s("label","Last name"),m(2),s("label","Street"),m(2),s("label","City"),m(2),s("label","State"),m(2),s("label","Zip  code")}}var Ie=(()=>{let e=class e{constructor(r,t){this.accountService=r,this.toaster=t}saveUserAddress(){this.accountService.updateUserAddress(this.checkoutForm?.get("addressForm")?.value).subscribe({next:()=>{this.toaster.success("Address saved"),this.checkoutForm?.get("addressForm")?.reset(this.checkoutForm?.get("addressForm")?.value)}})}};e.\u0275fac=function(t){return new(t||e)(u(Q),u(_))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-address"]],inputs:{checkoutForm:"checkoutForm"},decls:8,vars:2,consts:[["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["routerLink","/basket",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"mt-4",3,"formGroup"],[1,"d-flex","justify-content-between","align-items-center"],[1,"btn","btn-outline-success","mb-3",3,"click","disabled"],["formGroupName","addressForm",1,"row"],[1,"form-group","col-6"],["formControlName","firstName",3,"label"],["formControlName","lastName",3,"label"],["formControlName","street",3,"label"],["formControlName","city",3,"label"],["formControlName","state",3,"label"],["formControlName","zipcode",3,"label"]],template:function(t,o){if(t&1&&(v(0,Qe,19,8,"div",0),n(1,"div",1)(2,"button",2),l(3,"i",3),p(4," Back to basket "),c(),n(5,"button",4),p(6," Go to delivery "),l(7,"i",5),c()()),t&2){let d;s("ngIf",o.checkoutForm),m(5),s("disabled",o.checkoutForm==null||(d=o.checkoutForm.get("addressForm"))==null?null:d.invalid)}},dependencies:[g,U,S,F,x,w,E,W,I]});let i=e;return i})();var Y=(()=>{let e=class e{constructor(r){this.http=r,this.baseUrl=he.apiUrl}getDeliveryMethods(){return this.http.get(this.baseUrl+"orders/deliveryMethods").pipe(oe(r=>r.sort((t,o)=>o.price-t.price)))}createOrder(r){return this.http.post(this.baseUrl+"orders",r)}};e.\u0275fac=function(t){return new(t||e)(ae(ve))},e.\u0275prov=ne({token:e,factory:e.\u0275fac,providedIn:"root"});let i=e;return i})();function He(i,e){if(i&1){let a=V();n(0,"div",9)(1,"input",10),b("click",function(){let t=D(a).$implicit,o=h(2);return G(o.setShippingPrice(t))}),c(),n(2,"label",11)(3,"strong"),p(4),le(5,"currency"),c(),l(6,"br"),n(7,"span",12),p(8),c()()()}if(i&2){let a=e.$implicit;m(),L("id",a.id),L("value",a.id),m(),L("for",a.id),m(2),me("",a.shortName," - ",pe(5,6,a.price),""),m(4),R(a.description)}}function Ye(i,e){if(i&1&&(n(0,"div",6)(1,"div",7),v(2,He,9,8,"div",8),c()()),i&2){let a=h();s("formGroup",a.checkoutForm),m(2),s("ngForOf",a.deliveryMethods)}}var _e=(()=>{let e=class e{constructor(r,t){this.checkoutService=r,this.basketService=t,this.deliveryMethods=[]}ngOnInit(){this.checkoutService.getDeliveryMethods().subscribe({next:r=>this.deliveryMethods=r})}setShippingPrice(r){this.basketService.setShippingPrice(r)}};e.\u0275fac=function(t){return new(t||e)(u(Y),u(k))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-delivery"]],inputs:{checkoutForm:"checkoutForm"},decls:8,vars:2,consts:[["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"disabled"],[1,"fa","fa-angle-right"],[1,"mt-4",3,"formGroup"],["formGroupName","deliveryForm",1,"row"],["class","col-6 form-group",4,"ngFor","ngForOf"],[1,"col-6","form-group"],["formControlName","deliveryMethod","type","radio",1,"form-check-input",3,"click","id","value"],[1,"form-check-label","ms-2","mb-3",3,"for"],[1,"label-description"]],template:function(t,o){if(t&1&&(v(0,Ye,3,2,"div",0),n(1,"div",1)(2,"button",2),l(3,"i",3),p(4," Back to address "),c(),n(5,"button",4),p(6," Go to review "),l(7,"i",5),c()()),t&2){let d;s("ngIf",o.checkoutForm),m(5),s("disabled",o.checkoutForm==null||(d=o.checkoutForm.get("deliveryForm"))==null?null:d.invalid)}},dependencies:[de,g,ye,be,S,F,x,w,E,I,N,ue]});let i=e;return i})();var je=(()=>{let e=class e{constructor(r,t){this.basketService=r,this.toastr=t}createPaymentIntent(){this.basketService.createPaymentIntent().subscribe({next:()=>{this.appStepper?.next()},error:r=>this.toastr.error(r.message)})}};e.\u0275fac=function(t){return new(t||e)(u(k),u(_))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-review"]],inputs:{appStepper:"appStepper"},decls:9,vars:1,consts:[[1,"mt-4"],[3,"isBasket"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],[1,"btn","btn-primary",3,"click"],[1,"fa","fa-angle-right"]],template:function(t,o){t&1&&(n(0,"div",0),l(1,"app-basket-summary",1),c(),n(2,"div",2)(3,"button",3),l(4,"i",4),p(5," Back to delivery "),c(),n(6,"button",5),b("click",function(){return o.createPaymentIntent()}),p(7," Go to payment "),l(8,"i",6),c()()),t&2&&(m(),s("isBasket",!1))},dependencies:[N,Fe]});let i=e;return i})();var Te="https://js.stripe.com/v3",Ze=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,Me="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",$e=function(){for(var e=document.querySelectorAll('script[src^="'.concat(Te,'"]')),a=0;a<e.length;a++){var r=e[a];if(Ze.test(r.src))return r}return null},Pe=function(e){var a=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(Te).concat(a);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(r),r},Ke=function(e,a){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"3.5.0",startTime:a})},j=null,X=null,z=null,Je=function(e){return function(){e(new Error("Failed to load Stripe.js"))}},et=function(e,a){return function(){window.Stripe?e(window.Stripe):a(new Error("Stripe.js not available"))}},tt=function(e){return j!==null?j:(j=new Promise(function(a,r){if(typeof window>"u"||typeof document>"u"){a(null);return}if(window.Stripe&&e&&console.warn(Me),window.Stripe){a(window.Stripe);return}try{var t=$e();if(t&&e)console.warn(Me);else if(!t)t=Pe(e);else if(t&&z!==null&&X!==null){var o;t.removeEventListener("load",z),t.removeEventListener("error",X),(o=t.parentNode)===null||o===void 0||o.removeChild(t),t=Pe(e)}z=et(a,r),X=Je(r),t.addEventListener("load",z),t.addEventListener("error",X)}catch(d){r(d);return}}),j.catch(function(a){return j=null,Promise.reject(a)}))},rt=function(e,a,r){if(e===null)return null;var t=e.apply(void 0,a);return Ke(t,r),t},M,De=!1,Ge=function(){return M||(M=tt(null).catch(function(e){return M=null,Promise.reject(e)}),M)};Promise.resolve().then(function(){return Ge()}).catch(function(i){De||console.warn(i)});var Ve=function(){for(var e=arguments.length,a=new Array(e),r=0;r<e;r++)a[r]=arguments[r];De=!0;var t=Date.now();return Ge().then(function(o){return rt(o,a,t)})};var it=["cardNumber"],ot=["cardExpiry"],nt=["cardCvc"];function at(i,e){if(i&1&&(n(0,"div",10)(1,"div",11)(2,"div",12),l(3,"app-text-input",13),c()(),n(4,"div",14)(5,"div",15)(6,"div",16),l(7,"div",17,0),n(9,"label"),p(10,"Card Number"),c(),n(11,"span",18),p(12),c()()(),n(13,"div",19)(14,"div",16),l(15,"div",17,1),n(17,"label"),p(18,"Card Expiry"),c()()(),n(19,"div",19)(20,"div",16),l(21,"div",17,2),n(23,"label"),p(24,"Card Cvc"),c()()()()()),i&2){let a=h();s("formGroup",a.checkoutForm),m(3),s("label","Name on card"),m(9),R(a.cardErrors)}}function ct(i,e){i&1&&l(0,"i",20)}var Le=(()=>{let e=class e{constructor(r,t,o,d){this.basketService=r,this.checkoutService=t,this.toastr=o,this.router=d,this.stripe=null,this.cardNumberComplete=!1,this.cardCvcComplete=!1,this.cardExpiryComplete=!1,this.loading=!1}get paymentFormComplete(){return this.checkoutForm?.get("paymentForm")?.valid&&this.cardExpiryComplete&&this.cardNumberComplete&&this.cardCvcComplete}ngOnInit(){Ve("pk_test_51PTBYXDpeKeTdUYHyZonsFHC6OMHE2MUMedcgcSyj3MWdqYUTrn99XtsBR5q1HRC2mjc97uOuQzV9R60Ich2131w000QehHYvL").then(r=>{this.stripe=r;let t=r?.elements();t&&(this.cardNumber=t.create("cardNumber"),this.cardNumber.mount(this.cardNumberElement?.nativeElement),this.cardNumber.on("change",o=>{this.cardNumberComplete=o.complete,o.error?this.cardErrors=o.error?.message:this.cardErrors=null}),this.cardExpiry=t.create("cardExpiry"),this.cardExpiry.mount(this.cardExpiryElement?.nativeElement),this.cardExpiry.on("change",o=>{this.cardExpiryComplete=o.complete,o.error?this.cardErrors=o.error?.message:this.cardErrors=null}),this.cardCvc=t.create("cardCvc"),this.cardCvc.mount(this.cardCvcElement?.nativeElement),this.cardCvc.on("change",o=>{this.cardCvcComplete=o.complete,o.error?this.cardErrors=o.error?.message:this.cardErrors=null}))})}submitOrder(){return Z(this,null,function*(){this.loading=!0;let r=this.basketService.getCurrentBasketValue();if(!r)throw new Error("cannot get basket");try{let t=yield this.createOrder(r),o=yield this.confirmPaymentWithStripe(r);if(o.paymentIntent){this.basketService.deleteBasket(r);let d={state:t};this.router.navigate(["checkout/success"],d)}else this.toastr.error(o.error.message)}catch(t){console.log(t),this.toastr.error(t.message)}finally{this.loading=!1}})}getOrderToCreate(r){let t=this.checkoutForm?.get("deliveryForm")?.get("deliveryMethod")?.value,o=this.checkoutForm?.get("addressForm")?.value;if(!t||!o)throw new Error("Problem with basket");return{basketId:r.id,deliveryMethodId:t,shipToAddress:o}}createOrder(r){if(!r)throw new Error("Basket is null");let t=this.getOrderToCreate(r);return ie(this.checkoutService.createOrder(t))}confirmPaymentWithStripe(r){return Z(this,null,function*(){if(!r)throw new Error("Basket is null");let t=this.stripe?.confirmCardPayment(r.clientSecret,{payment_method:{card:this.cardNumber,billing_details:{name:this.checkoutForm?.get("paymentForm")?.get("nameOnCard")?.value}}});if(!t)throw new Error("Problem attempting payment with stripe");return t})}};e.\u0275fac=function(t){return new(t||e)(u(k),u(Y),u(_),u(q))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-payment"]],viewQuery:function(t,o){if(t&1&&(O(it,5),O(ot,5),O(nt,5)),t&2){let d;A(d=B())&&(o.cardNumberElement=d.first),A(d=B())&&(o.cardExpiryElement=d.first),A(d=B())&&(o.cardCvcElement=d.first)}},inputs:{checkoutForm:"checkoutForm"},decls:9,vars:3,consts:[["cardNumber",""],["cardExpiry",""],["cardCvc",""],["class","mt-4",3,"formGroup",4,"ngIf"],[1,"d-flex","justify-content-between","flex-row","mb-5"],["cdkStepperPrevious","",1,"btn","btn-outline-primary"],[1,"fa","fa-angle-left"],["cdkStepperNext","",1,"btn","btn-primary",3,"click","disabled"],[1,"fa","fa-angle-right"],["class","fa fa-spinner fa-spin",4,"ngIf"],[1,"mt-4",3,"formGroup"],[1,"row"],["formGroupName","paymentForm",1,"form-group","col-12"],["formControlName","nameOnCard",3,"label"],[1,"row","mb-3"],[1,"col-6"],[1,"form-floating"],[1,"form-control"],[1,"text-danger"],[1,"col-3"],[1,"fa","fa-spinner","fa-spin"]],template:function(t,o){t&1&&(v(0,at,25,3,"div",3),n(1,"div",4)(2,"button",5),l(3,"i",6),p(4," Back to review "),c(),n(5,"button",7),b("click",function(){return o.submitOrder()}),p(6," Submit order "),l(7,"i",8),v(8,ct,1,0,"i",9),c()()),t&2&&(s("ngIf",o.checkoutForm),m(5),s("disabled",o.loading||!o.paymentFormComplete),m(3),s("ngIf",o.loading))},dependencies:[g,S,F,x,w,E,W,I,N]});let i=e;return i})();var Oe=(()=>{let e=class e{constructor(r,t,o){this.fb=r,this.accountService=t,this.basketService=o,this.checkoutForm=this.fb.group({addressForm:this.fb.group({firstName:["",y.required],lastName:["",y.required],street:["",y.required],city:["",y.required],state:["",y.required],zipcode:["",y.required]}),deliveryForm:this.fb.group({deliveryMethod:["",y.required]}),paymentForm:this.fb.group({nameOnCard:["",y.required]})})}ngOnInit(){this.getAddressFormValues(),this.getDeliveryMethodValue()}getAddressFormValues(){this.accountService.getUserAddress().subscribe({next:r=>{r&&this.checkoutForm.get("addressForm")?.patchValue(r)}})}getDeliveryMethodValue(){let r=this.basketService.getCurrentBasketValue();r&&r.deliveryMethodId&&this.checkoutForm.get("deliveryForm")?.get("deliveryMethod")?.patchValue(r.deliveryMethodId.toString())}};e.\u0275fac=function(t){return new(t||e)(u(ge),u(Q),u(k))},e.\u0275cmp=f({type:e,selectors:[["app-checkout"]],decls:15,vars:11,consts:[["appStepper",""],[1,"container","mt-5"],[1,"row"],[1,"col-8"],[3,"completed","label"],[3,"checkoutForm"],[3,"label"],[3,"appStepper"],[1,"col-4"]],template:function(t,o){if(t&1&&(n(0,"div",1)(1,"div",2)(2,"div",3)(3,"app-stepper",null,0)(5,"cdk-step",4),l(6,"app-checkout-address",5),c(),n(7,"cdk-step",4),l(8,"app-checkout-delivery",5),c(),n(9,"cdk-step",6),l(10,"app-checkout-review",7),c(),n(11,"cdk-step",4),l(12,"app-checkout-payment",5),c()()(),n(13,"div",8),l(14,"app-order-totals"),c()()()),t&2){let d,te,re,Re=se(4);m(5),s("completed",(d=o.checkoutForm.get("addressForm"))==null?null:d.valid)("label","Address"),m(),s("checkoutForm",o.checkoutForm),m(),s("completed",(te=o.checkoutForm.get("deliveryForm"))==null?null:te.valid)("label","Delivery"),m(),s("checkoutForm",o.checkoutForm),m(),s("label","Review"),m(),s("appStepper",Re),m(),s("completed",(re=o.checkoutForm.get("paymentForm"))==null?null:re.valid)("label","Payment"),m(),s("checkoutForm",o.checkoutForm)}},dependencies:[ke,Se,Ce,Ie,_e,je,Le]});let i=e;return i})();function mt(i,e){if(i&1&&(n(0,"button",5),p(1," View your order "),c()),i&2){let a=h();ce("routerLink","/orders/",a.order.id,"")}}function lt(i,e){i&1&&(n(0,"button",6),p(1," View your orders "),c())}var Ae=(()=>{let e=class e{constructor(r){this.router=r;let t=this.router.getCurrentNavigation();this.order=t?.extras?.state}};e.\u0275fac=function(t){return new(t||e)(u(q))},e.\u0275cmp=f({type:e,selectors:[["app-checkout-success"]],decls:9,vars:2,consts:[[1,"container","mt-5"],[1,"fa","fa-check-circle","fa-5x",2,"color","green"],[1,"mb-4"],["class","btn btn-outline-success",3,"routerLink",4,"ngIf"],["class","btn btn-outline-success","routerLink","/orders",4,"ngIf"],[1,"btn","btn-outline-success",3,"routerLink"],["routerLink","/orders",1,"btn","btn-outline-success"]],template:function(t,o){t&1&&(n(0,"div",0)(1,"div"),l(2,"i",1),c(),n(3,"h2"),p(4,"Thank you. Your order is confirmed"),c(),n(5,"p",2),p(6,"Your order has not shipped yet, but this is to be expected as we a re not a real store!"),c(),v(7,mt,2,2,"button",3)(8,lt,2,0,"button",4),c()),t&2&&(m(7),s("ngIf",o.order),m(),s("ngIf",!o.order))},dependencies:[g,U]});let i=e;return i})();var pt=[{path:"",component:Oe},{path:"success",component:Ae}],Be=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=T({type:e}),e.\u0275inj=P({imports:[$.forChild(pt),$]});let i=e;return i})();var Ht=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=T({type:e}),e.\u0275inj=P({imports:[fe,Be,xe]});let i=e;return i})();export{Ht as CheckoutModule};
